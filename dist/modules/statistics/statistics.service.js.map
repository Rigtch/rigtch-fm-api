{"version":3,"sources":["../../../src/modules/statistics/statistics.service.ts"],"sourcesContent":["import { HttpService } from '@nestjs/axios'\nimport { Injectable } from '@nestjs/common'\nimport { Observable, map, catchError, mergeMap } from 'rxjs'\n\nimport { analysisFactory } from './utils'\nimport { TimeRange } from './enums'\n\nimport { Genres, Analysis } from '@common/dtos'\nimport {\n  FormattedTrack,\n  SpotifyResponse,\n  SpotifyTrack,\n  SpotifyArtist,\n  FormattedArtist,\n  SpotifyAudioFeatures,\n} from '@common/types/spotify'\nimport { applyAuthorizationHeader, catchSpotifyError } from '~/utils'\nimport {\n  adaptArtist,\n  adaptArtists,\n  adaptAudioFeatures,\n  adaptGenres,\n  adaptTracks,\n} from '@common/adapters'\n\n@Injectable()\nexport class StatisticsService {\n  constructor(private readonly httpService: HttpService) {}\n\n  lastTracks(accessToken: string, limit = 20): Observable<FormattedTrack[]> {\n    const urlSearchParameters = new URLSearchParams({\n      limit: limit + '',\n    })\n\n    console.log(urlSearchParameters.toString())\n\n    return this.httpService\n      .get<SpotifyResponse<{ track: SpotifyTrack; played_at: string }>>(\n        `/me/player/recently-played?${urlSearchParameters.toString()}`,\n        applyAuthorizationHeader(accessToken)\n      )\n      .pipe(\n        map(response => response.data.items),\n        map(items =>\n          items.map(({ track, played_at }) => ({\n            ...track,\n            played_at,\n          }))\n        ),\n        map(adaptTracks),\n        catchError(catchSpotifyError)\n      )\n  }\n\n  topGenres(\n    accessToken: string,\n    limit = 10,\n    timeRange = TimeRange.LONG_TERM,\n    offset = 1\n  ): Observable<Genres> {\n    const urlSearchParameters = new URLSearchParams({\n      limit: limit + '',\n      offset: offset + '',\n      time_range: timeRange,\n    })\n\n    return this.httpService\n      .get<SpotifyResponse<SpotifyArtist>>(\n        `/me/top/artists?${urlSearchParameters.toString()}`,\n        applyAuthorizationHeader(accessToken)\n      )\n      .pipe(\n        map(response => response.data.items),\n        map(items => adaptGenres(items, limit)),\n        catchError(catchSpotifyError)\n      )\n  }\n\n  topArtists(\n    accessToken: string,\n    limit = 10,\n    timeRange = TimeRange.LONG_TERM,\n    offset = 1\n  ): Observable<FormattedArtist[]> {\n    const urlSearchParameters = new URLSearchParams({\n      limit: limit + '',\n      offset: offset + '',\n      time_range: timeRange,\n    })\n\n    return this.httpService\n      .get<SpotifyResponse<SpotifyArtist>>(\n        `/me/top/artists?${urlSearchParameters.toString()}`,\n        applyAuthorizationHeader(accessToken)\n      )\n      .pipe(\n        map(response => response.data.items),\n        map(adaptArtists),\n        catchError(catchSpotifyError)\n      )\n  }\n\n  topTracks(\n    accessToken: string,\n    limit = 10,\n    timeRange = TimeRange.LONG_TERM,\n    offset = 1\n  ): Observable<FormattedTrack[]> {\n    const urlSearchParameters = new URLSearchParams({\n      limit: limit + '',\n      offset: offset + '',\n      time_range: timeRange,\n    })\n\n    return this.httpService\n      .get<SpotifyResponse<SpotifyTrack>>(\n        `/me/top/tracks?${urlSearchParameters.toString()}`,\n        applyAuthorizationHeader(accessToken)\n      )\n      .pipe(\n        map(response => response.data.items),\n        map(adaptTracks),\n        catchError(catchSpotifyError)\n      )\n  }\n\n  artist(accessToken: string, id: string) {\n    return this.httpService\n      .get<SpotifyArtist>(\n        `/artists/${id}`,\n        applyAuthorizationHeader(accessToken)\n      )\n      .pipe(\n        map(response => response.data),\n        map(adaptArtist),\n        catchError(catchSpotifyError)\n      )\n  }\n\n  analysis(accessToken: string): Observable<Analysis> {\n    return this.topTracks(accessToken, 50).pipe(\n      mergeMap(tracks => {\n        const tracksIds = tracks.map(({ id }) => id).join(',')\n\n        return this.httpService\n          .get<{ audio_features: SpotifyAudioFeatures[] }>(\n            `/audio-features?ids=${tracksIds}`,\n            applyAuthorizationHeader(accessToken)\n          )\n          .pipe(\n            map(response => response.data.audio_features),\n            map(audioFeatures =>\n              audioFeatures.map(audioFeature =>\n                adaptAudioFeatures(audioFeature)\n              )\n            ),\n            map(analysisFactory),\n            catchError(catchSpotifyError)\n          )\n      })\n    )\n  }\n}\n"],"names":["StatisticsService","lastTracks","accessToken","limit","urlSearchParameters","URLSearchParams","console","log","toString","httpService","get","applyAuthorizationHeader","pipe","map","response","data","items","track","played_at","adaptTracks","catchError","catchSpotifyError","topGenres","timeRange","TimeRange","LONG_TERM","offset","time_range","adaptGenres","topArtists","adaptArtists","topTracks","artist","id","adaptArtist","analysis","mergeMap","tracks","tracksIds","join","audio_features","audioFeatures","audioFeature","adaptAudioFeatures","analysisFactory","constructor","Injectable"],"mappings":"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"}
