{"version":3,"sources":["../../../src/modules/auth/auth.service.ts"],"sourcesContent":["import { HttpService } from '@nestjs/axios'\nimport { Injectable } from '@nestjs/common'\nimport { ConfigService } from '@nestjs/config'\nimport { JwtService } from '@nestjs/jwt'\nimport { Profile } from 'passport-spotify'\nimport { Observable, map, catchError } from 'rxjs'\n\nimport { SecretData } from './dtos'\nimport { TokenOptions } from './types'\n\nimport { Environment } from '~/config'\nimport {\n  SpotifyToken,\n  FormattedProfile,\n  SpotifyProfile,\n} from '@common/types/spotify'\nimport { applyAuthorizationHeader, catchSpotifyError } from '~/utils'\nimport { adaptProfile, adaptSecretData } from '@common/adapters'\n\n@Injectable()\nexport class AuthService {\n  constructor(\n    private readonly jwtService: JwtService,\n    private readonly httpService: HttpService,\n    private readonly configService: ConfigService\n  ) {}\n\n  login({ id, username }: Profile) {\n    const payload = {\n      name: username,\n      sub: id,\n    }\n\n    return this.jwtService.sign(payload)\n  }\n\n  token({ refreshToken, code }: TokenOptions): Observable<SecretData> {\n    const url = `${this.configService.get(\n      Environment.SPOTIFY_ACCOUNTS_URL\n    )}/api/token`\n    const cliendId = this.configService.get(Environment.SPOTIFY_CLIENT_ID)\n    const clientSecret = this.configService.get(\n      Environment.SPOTIFY_CLIENT_SECRET\n    )\n    const bufferedCredentials = Buffer.from(\n      `${cliendId}:${clientSecret}`\n    ).toString('base64')\n    const parameters = new URLSearchParams()\n\n    if (refreshToken) {\n      parameters.append('refresh_token', refreshToken)\n      parameters.append('grant_type', 'refresh_token')\n    }\n    if (code) {\n      parameters.append('code', code)\n      parameters.append('grant_type', 'authorization_code')\n      parameters.append(\n        'redirect_uri',\n        this.configService.get(Environment.SPOTIFY_CALLBACK_URL)\n      )\n    }\n\n    return this.httpService\n      .post<SpotifyToken>(url, parameters, {\n        headers: {\n          'Content-Type': 'application/x-www-form-urlencoded',\n          Authorization: `Basic ${bufferedCredentials}`,\n        },\n      })\n      .pipe(\n        map(response => response.data),\n        map(adaptSecretData),\n        catchError(catchSpotifyError)\n      )\n  }\n\n  profile(accessToken: string): Observable<FormattedProfile> {\n    return this.httpService\n      .get<SpotifyProfile>('/me', applyAuthorizationHeader(accessToken))\n      .pipe(\n        map(response => response.data),\n        map(adaptProfile),\n        catchError(catchSpotifyError)\n      )\n  }\n}\n"],"names":["AuthService","login","id","username","payload","name","sub","jwtService","sign","token","refreshToken","code","url","configService","get","Environment","SPOTIFY_ACCOUNTS_URL","cliendId","SPOTIFY_CLIENT_ID","clientSecret","SPOTIFY_CLIENT_SECRET","bufferedCredentials","Buffer","from","toString","parameters","URLSearchParams","append","SPOTIFY_CALLBACK_URL","httpService","post","headers","Authorization","pipe","map","response","data","adaptSecretData","catchError","catchSpotifyError","profile","accessToken","applyAuthorizationHeader","adaptProfile","constructor","Injectable"],"mappings":";;;;+BAoBaA;;;eAAAA;;;uBApBe;wBACD;wBACG;qBACH;sBAEiB;yBAKhB;uBAMgC;0BACd;;;;;;;;;;IAGjCA,cAAN;IAOLC,MAAM,EAAEC,EAAE,EAAEC,QAAQ,EAAW,EAAE;QAC/B,MAAMC,UAAU;YACdC,MAAMF;YACNG,KAAKJ;QACP;QAEA,OAAO,IAAI,CAACK,UAAU,CAACC,IAAI,CAACJ;IAC9B;IAEAK,MAAM,EAAEC,YAAY,EAAEC,IAAI,EAAgB,EAA0B;QAClE,MAAMC,MAAM,CAAC,EAAE,IAAI,CAACC,aAAa,CAACC,GAAG,CACnCC,oBAAW,CAACC,oBAAoB,EAChC,UAAU,CAAC;QACb,MAAMC,WAAW,IAAI,CAACJ,aAAa,CAACC,GAAG,CAACC,oBAAW,CAACG,iBAAiB;QACrE,MAAMC,eAAe,IAAI,CAACN,aAAa,CAACC,GAAG,CACzCC,oBAAW,CAACK,qBAAqB;QAEnC,MAAMC,sBAAsBC,OAAOC,IAAI,CACrC,CAAC,EAAEN,SAAS,CAAC,EAAEE,aAAa,CAAC,EAC7BK,QAAQ,CAAC;QACX,MAAMC,aAAa,IAAIC;QAEvB,IAAIhB,cAAc;YAChBe,WAAWE,MAAM,CAAC,iBAAiBjB;YACnCe,WAAWE,MAAM,CAAC,cAAc;QAClC;QACA,IAAIhB,MAAM;YACRc,WAAWE,MAAM,CAAC,QAAQhB;YAC1Bc,WAAWE,MAAM,CAAC,cAAc;YAChCF,WAAWE,MAAM,CACf,gBACA,IAAI,CAACd,aAAa,CAACC,GAAG,CAACC,oBAAW,CAACa,oBAAoB;QAE3D;QAEA,OAAO,IAAI,CAACC,WAAW,CACpBC,IAAI,CAAelB,KAAKa,YAAY;YACnCM,SAAS;gBACP,gBAAgB;gBAChBC,eAAe,CAAC,MAAM,EAAEX,oBAAoB,CAAC;YAC/C;QACF,GACCY,IAAI,CACHC,IAAAA,SAAG,EAACC,CAAAA,WAAYA,SAASC,IAAI,GAC7BF,IAAAA,SAAG,EAACG,yBAAe,GACnBC,IAAAA,gBAAU,EAACC,wBAAiB;IAElC;IAEAC,QAAQC,WAAmB,EAAgC;QACzD,OAAO,IAAI,CAACZ,WAAW,CACpBf,GAAG,CAAiB,OAAO4B,IAAAA,+BAAwB,EAACD,cACpDR,IAAI,CACHC,IAAAA,SAAG,EAACC,CAAAA,WAAYA,SAASC,IAAI,GAC7BF,IAAAA,SAAG,EAACS,sBAAY,GAChBL,IAAAA,gBAAU,EAACC,wBAAiB;IAElC;IA/DAK,YACmBrC,YACAsB,aACAhB,cACjB;0BAHiBN;2BACAsB;6BACAhB;IAChB;AA4DL;AAjEab;IADZ6C,IAAAA,kBAAU;;;eAGsB,eAAU,4BAAV,eAAU;eACT,kBAAW,4BAAX,kBAAW;eACT,qBAAa,4BAAb,qBAAa;;GAJpC7C"}